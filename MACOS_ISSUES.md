# macOS 常见问题解决方案

## 🔴 问题：点击后屏幕分辨率被改变

### 问题描述
点击"识别并点击"按钮后，macOS 的屏幕分辨率或显示缩放被意外改变。

### 可能的原因

1. **系统快捷键冲突**
   - macOS 有很多系统快捷键和手势
   - 鼠标移动或点击可能意外触发了系统功能

2. **辅助功能权限问题**
   - 权限不完整可能导致系统异常行为
   - macOS 的安全机制可能拦截了某些操作

3. **显示缩放设置**
   - macOS 的"缩放"功能可能被触发
   - 三指手势或快捷键可能被误触

4. **Mission Control / Spaces**
   - 可能触发了 Mission Control 或切换桌面空间的功能

### 解决方案

#### 方案 1：检查系统快捷键设置

1. **打开系统设置**
   ```
   系统设置 → 键盘 → 键盘快捷键
   ```

2. **检查以下快捷键是否启用**
   - 辅助功能 → 缩放
   - Mission Control → 相关快捷键
   - 调度中心 → 相关手势

3. **建议临时禁用**
   - 辅助功能中的"缩放"功能
   - 不必要的三指/四指手势

#### 方案 2：完整授予辅助功能权限

1. **打开系统设置**
   ```
   系统设置 → 隐私与安全性 → 辅助功能
   ```

2. **添加以下应用**
   - ✅ 终端 (Terminal)
   - ✅ Python (如果单独安装)
   - ✅ 你使用的代码编辑器（VS Code 等）

3. **重启服务**
   ```bash
   # 停止当前服务（Ctrl+C）
   # 重新启动
   ./start.sh
   ```

#### 方案 3：禁用触控板手势

1. **打开系统设置**
   ```
   系统设置 → 触控板
   ```

2. **临时禁用以下手势**
   - 缩放（两指捏合）
   - 智能缩放（双指轻点两下）
   - 旋转

#### 方案 4：使用 --no-sandbox 模式（不推荐）

仅在测试时使用，生产环境不推荐。

### 代码层面的改进

我已经在代码中添加了以下保护措施：

```python
# 1. PyAutoGUI 安全配置
pyautogui.FAILSAFE = True  # 紧急停止
pyautogui.PAUSE = 0.1      # 操作间隔

# 2. 验证坐标范围
screen_width, screen_height = pyautogui.size()
if not (0 <= x <= screen_width and 0 <= y <= screen_height):
    # 拒绝超出范围的坐标
    return error

# 3. 使用缓动函数移动
pyautogui.moveTo(x, y, duration=0.5, tween=pyautogui.easeInOutQuad)

# 4. 增加等待时间
await asyncio.sleep(0.3)

# 5. 明确指定点击参数
pyautogui.click(x, y, clicks=1, interval=0.1, button='left')
```

### 检查清单

使用前请确认：

- [ ] 已授予完整的辅助功能权限
- [ ] 已检查系统快捷键设置
- [ ] 已禁用不必要的触控板手势
- [ ] 查看日志确认坐标在正常范围内
- [ ] 在测试环境中先验证

### 调试步骤

1. **查看实时日志**
   ```
   执行操作时，注意右侧日志输出：
   📺 屏幕尺寸: 1920x1080
   🖱️ 准备点击坐标: (500, 300)
   ✅ 点击成功！位置: (500, 300)
   ```

2. **检查坐标是否正常**
   - 坐标应该在屏幕范围内
   - 例如：1920x1080 的屏幕，坐标不应超过这个范围

3. **测试简单位置**
   - 先在屏幕中央区域测试
   - 避免靠近屏幕边缘或角落

### 临时禁用缩放功能

**选项 A：系统设置**
```
系统设置 → 辅助功能 → 缩放
关闭 "使用键盘快捷键来缩放"
关闭 "使用滚动手势配合修饰键来缩放"
```

**选项 B：终端命令**
```bash
# 查看当前缩放设置
defaults read com.apple.universalaccess closeViewScrollWheelToggle

# 临时禁用（需要重启）
defaults write com.apple.universalaccess closeViewScrollWheelToggle -bool false
```

### 其他可能的干扰

1. **第三方软件**
   - Better Touch Tool
   - Alfred
   - Magnet / Rectangle
   - 检查这些工具是否有冲突的快捷键

2. **显示器设置**
   - 确认不是外接显示器的问题
   - 检查显示器的原生分辨率设置

3. **系统版本**
   - macOS Ventura (13.x) 及以上版本
   - 某些版本可能有已知问题

### 最佳实践

1. **测试环境隔离**
   - 在不重要的应用上先测试
   - 不要在生产环境直接使用

2. **保存屏幕设置**
   - 记录当前的分辨率和缩放设置
   - 方便出问题后恢复

3. **使用虚拟机测试**
   - 可以在虚拟机中测试
   - 避免影响主系统

### 紧急恢复

如果分辨率被改变：

1. **快速恢复**
   ```
   系统设置 → 显示器
   选择推荐的分辨率
   ```

2. **使用快捷键**
   ```
   Cmd + F1 - 检测显示器
   ```

3. **重启电脑**
   - 大多数设置会恢复默认值

### 报告问题

如果问题持续存在，请提供：

1. macOS 版本
2. Python 版本
3. 屏幕分辨率
4. 完整的日志输出
5. 具体的操作步骤

### 联系支持

- 查看日志文件：`backend/logs/`
- 查看上传的图片：`backend/uploads/`
- 提交 Issue 并附上相关信息

---

**更新时间**: 2025-10-10  
**适用版本**: MVP 1.0+  
**测试平台**: macOS 13.x (Ventura), 14.x (Sonoma)
